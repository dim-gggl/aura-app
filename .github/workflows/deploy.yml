name: Deploy to Server
permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      skip_backup:
        description: 'Skip backup before deployment'
        required: false
        type: boolean
        default: false

  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'

env:
  DEPLOY_PATH: /var/www/aura-app

jobs:
  # ============================================================================
  # Pre-deployment Checks
  # ============================================================================
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose files
        run: |
          docker compose config --quiet
          docker compose -f docker-compose.yml -f docker-compose.prod.yml config --quiet

      - name: Check if deploy.sh exists
        run: |
          if [ ! -f "deploy.sh" ]; then
            echo "deploy.sh not found!"
            exit 1
          fi

      - name: Validate bash scripts
        run: |
          bash -n deploy.sh
          bash -n backup.sh
          bash -n entrypoint.sh

  # ============================================================================
  # Deploy to Staging
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/develop')
    environment:
      name: staging
      url: https://staging.aura-art.org

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup (if not skipped)
        if: github.event.inputs.skip_backup != 'true'
        run: |
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            ./backup.sh
          EOF

      - name: Deploy to staging server
        run: |
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "üì¶ Pulling latest changes..."
            git fetch origin
            git checkout develop
            git pull origin develop

            echo "üîß Running deployment script..."
            ./deploy.sh staging

            echo "‚úÖ Deployment completed!"
          EOF

      - name: Health check
        run: |
          sleep 10
          curl -f https://staging.aura-art.org/health/ || exit 1

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Staging deployment failed!"

  # ============================================================================
  # Deploy to Production
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment:
      name: production
      url: https://aura-art.org

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup (mandatory for production)
        if: github.event.inputs.skip_backup != 'true'
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "üì¶ Creating backup..."
            ./backup.sh --upload
            echo "‚úÖ Backup completed"
          EOF

      - name: Deploy to production server
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            set -e
            cd ${{ env.DEPLOY_PATH }}

            echo "üì¶ Pulling latest changes..."
            git fetch origin
            git checkout main
            git pull origin main

            echo "üîß Running deployment script..."
            ./deploy.sh production

            echo "‚úÖ Deployment completed!"
          EOF

      - name: Health check
        run: |
          sleep 15
          curl -f https://aura-art.org/health/ || exit 1

      - name: Verify SSL certificate
        run: |
          echo | openssl s_client -servername aura-art.org -connect aura-art.org:443 2>/dev/null | openssl x509 -noout -dates

      - name: Create deployment tag
        if: success()
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          TAG_NAME="deploy-$(date +%Y%m%d-%H%M%S)"
          git tag -a "$TAG_NAME" -m "Production deployment on $(date)"
          git push origin "$TAG_NAME" || echo "Failed to push tag"

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Production deployment successful!"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Production deployment failed! Consider rollback."
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            echo "Checking logs..."
            docker compose logs --tail=50
          EOF

  # ============================================================================
  # Post-deployment Tests
  # ============================================================================
  post-deploy-tests:
    name: Post-deployment Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')

    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "url=https://aura-art.org" >> $GITHUB_OUTPUT
            echo "name=production" >> $GITHUB_OUTPUT
          else
            echo "url=https://staging.aura-art.org" >> $GITHUB_OUTPUT
            echo "name=staging" >> $GITHUB_OUTPUT
          fi

      - name: Test health endpoint
        run: |
          curl -f ${{ steps.env.outputs.url }}/health/

      - name: Test home page
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.env.outputs.url }}/)
          if [ $STATUS -ne 200 ]; then
            echo "Home page returned status $STATUS"
            exit 1
          fi

      - name: Test API endpoint
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.env.outputs.url }}/api/)
          if [ $STATUS -ne 200 ] && [ $STATUS -ne 401 ]; then
            echo "API returned unexpected status $STATUS"
            exit 1
          fi

      - name: Test static files
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.env.outputs.url }}/static/favicon/favicon.ico)
          if [ $STATUS -ne 200 ]; then
            echo "Static files not accessible (status $STATUS)"
            exit 1
          fi

      - name: Test admin page (expect redirect)
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L ${{ steps.env.outputs.url }}/admin/)
          if [ $STATUS -ne 200 ]; then
            echo "Admin page not accessible (status $STATUS)"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ steps.env.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.env.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
