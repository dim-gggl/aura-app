name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # ============================================================================
  # PR Validation
  # ============================================================================
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
        continue-on-error: true

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          git merge-base --is-ancestor origin/${{ github.base_ref }} HEAD || {
            echo "::error::Branch is behind base branch. Please rebase."
            exit 1
          }

      - name: Check file sizes
        run: |
          LARGE_FILES=$(find . -type f -size +5M -not -path "./.git/*" -not -path "./media/*" -not -path "./staticfiles/*")
          if [ -n "$LARGE_FILES" ]; then
            echo "::error::Large files detected (>5MB):"
            echo "$LARGE_FILES"
            exit 1
          fi

  # ============================================================================
  # Code Quality Report
  # ============================================================================
  code-quality:
    name: Code Quality Report
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort radon pylint bandit

      - name: Calculate code complexity
        id: complexity
        run: |
          echo "### Code Complexity Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Cyclomatic Complexity" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          radon cc . -a -s || true >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Maintainability Index" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          radon mi . -s || true >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Run Black formatting check
        id: black
        run: |
          black --check --diff . > black_report.txt 2>&1 || true
          if [ -s black_report.txt ]; then
            echo "formatting_issues=true" >> $GITHUB_OUTPUT
          else
            echo "formatting_issues=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run isort check
        id: isort
        run: |
          isort --check-only --diff . > isort_report.txt 2>&1 || true
          if [ -s isort_report.txt ]; then
            echo "import_issues=true" >> $GITHUB_OUTPUT
          else
            echo "import_issues=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run Flake8
        id: flake8
        run: |
          flake8 . --count --statistics --output-file=flake8_report.txt || true
          if [ -s flake8_report.txt ]; then
            echo "linting_issues=true" >> $GITHUB_OUTPUT
          else
            echo "linting_issues=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');

            let comment = '## üîç Code Quality Report\n\n';

            // Black formatting
            if ('${{ steps.black.outputs.formatting_issues }}' === 'true') {
              comment += '‚ùå **Black Formatting**: Issues found\n';
              try {
                const blackReport = fs.readFileSync('black_report.txt', 'utf8');
                comment += '<details><summary>View Details</summary>\n\n```diff\n' + blackReport.substring(0, 2000) + '\n```\n</details>\n\n';
              } catch (e) {}
            } else {
              comment += '‚úÖ **Black Formatting**: Passed\n';
            }

            // isort
            if ('${{ steps.isort.outputs.import_issues }}' === 'true') {
              comment += '‚ùå **Import Sorting**: Issues found\n';
              try {
                const isortReport = fs.readFileSync('isort_report.txt', 'utf8');
                comment += '<details><summary>View Details</summary>\n\n```diff\n' + isortReport.substring(0, 2000) + '\n```\n</details>\n\n';
              } catch (e) {}
            } else {
              comment += '‚úÖ **Import Sorting**: Passed\n';
            }

            // Flake8
            if ('${{ steps.flake8.outputs.linting_issues }}' === 'true') {
              comment += '‚ö†Ô∏è **Flake8 Linting**: Issues found\n';
              try {
                const flake8Report = fs.readFileSync('flake8_report.txt', 'utf8');
                comment += '<details><summary>View Details</summary>\n\n```\n' + flake8Report.substring(0, 2000) + '\n```\n</details>\n\n';
              } catch (e) {}
            } else {
              comment += '‚úÖ **Flake8 Linting**: Passed\n';
            }

            comment += '\n---\n*Automated code quality check*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================================================
  # Security Scan
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          pip install bandit safety

      - name: Run Bandit
        id: bandit
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -ll || true
        continue-on-error: true

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

  # ============================================================================
  # Test Coverage
  # ============================================================================
  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: aura_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: aura_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev
          pip install uv
          uv pip install -r requirements.txt --system
          pip install pytest pytest-django pytest-cov

      - name: Setup database
        env:
          DATABASE_URL: postgresql://aura_user:test_password@localhost:5432/aura_test_db
        run: |
          PGPASSWORD=test_password psql -h localhost -U aura_user -d aura_test_db -c "CREATE SCHEMA IF NOT EXISTS aura;"

      - name: Run tests with coverage
        env:
          SECRET_KEY: test-secret-key
          DATABASE_URL: postgresql://aura_user:test_password@localhost:5432/aura_test_db
          DJANGO_SETTINGS_MODULE: aura_app.settings.tests
        run: |
          pytest --cov=. --cov-report=xml --cov-report=term --cov-report=html

      - name: Generate coverage badge
        uses: cicirello/jacoco-badge-generator@v2
        if: always()
        with:
          badges-directory: badges
          generate-coverage-badge: true
          coverage-badge-filename: coverage.svg

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/

      - name: Comment PR with coverage
        uses: py-cov-action/python-coverage-comment-action@v3
        if: always()
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 60

  # ============================================================================
  # Changed Files Analysis
  # ============================================================================
  analyze-changes:
    name: Analyze Changes
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.py
            requirements.txt
            Dockerfile
            docker-compose*.yml
            .env.production.example

      - name: Analyze changes
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "### üìù Changed Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if migrations were added
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "migrations/"; then
            echo "‚ö†Ô∏è **Migration files detected** - Review carefully!" >> $GITHUB_STEP_SUMMARY
          fi

          # Check if requirements changed
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "requirements.txt"; then
            echo "üì¶ **Dependencies changed** - Review security implications" >> $GITHUB_STEP_SUMMARY
          fi

          # Check if Docker files changed
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "Dockerfile\|docker-compose"; then
            echo "üê≥ **Docker configuration changed** - Test locally before merge" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Size Check
  # ============================================================================
  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const additions = pr.data.additions;
            const deletions = pr.data.deletions;
            const total = additions + deletions;

            let size = 'small';
            let emoji = '‚úÖ';

            if (total > 1000) {
              size = 'extra large';
              emoji = 'üö®';
            } else if (total > 500) {
              size = 'large';
              emoji = '‚ö†Ô∏è';
            } else if (total > 200) {
              size = 'medium';
              emoji = 'üìù';
            }

            const comment = `${emoji} **PR Size: ${size}**\n\n` +
              `- Additions: ${additions}\n` +
              `- Deletions: ${deletions}\n` +
              `- Total changes: ${total}\n\n` +
              (total > 500 ? '‚ö†Ô∏è Consider breaking this PR into smaller chunks for easier review.' : '');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
