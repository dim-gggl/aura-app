{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} - Catalogue{% endblock %}

{% block extra_css %}
<style>
  .photo-preview {
    max-width: 150px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 0.375rem;
  }

  /* Input-group sur toute la ligne */
  .select-or-create-wrapper,
  .select-multiple-or-create-wrapper {
    width: 100%;
  }

  .select-or-create,
  .select-multiple-or-create {
    flex: 1 1 auto;
  }

  /* Espacements plus lisibles */
  .form-row .form-group { margin-bottom: 1rem !important; }
  fieldset { margin-bottom: 1.25rem; }
  fieldset legend {
    font-size: 1.05rem;
    margin-bottom: .25rem;
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  .photo-form {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
    background-color: #f8f9fa;
  }

  .photo-form.deleted {
    opacity: 0.5;
    background-color: #e9ecef;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">{{ title }}</h1>
                <a href="{% if artwork %}{{ artwork.get_absolute_url }}{% else %}{% url 'artworks:list' %}{% endif %}" 
                   class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Annuler
                </a>
            </div>
            
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Formulaire principal -->
                <div class="card">
                    <div class="card-body">
                        {% crispy form %}
                    </div>
                </div>
                
                <!-- Photos -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-images"></i> Photos
                        </h5>
                    </div>
                    <div class="card-body">
                        {{ photo_formset.management_form }}
                        
                        {% if photo_formset.non_form_errors %}
                            <div class="alert alert-danger">
                                {{ photo_formset.non_form_errors }}
                            </div>
                        {% endif %}
                        
                        <div id="photo-forms">
                            {% for form in photo_formset %}
                                <div class="photo-form" data-form-index="{{ forloop.counter0 }}">
                                    {% if form.instance.image %}
                                        <div class="mb-2">
                                            <img src="{{ form.instance.image.url }}" class="photo-preview">
                                        </div>
                                    {% endif %}
                                    
                                    {% if form.errors %}
                                        <div class="alert alert-danger">
                                            {{ form.errors }}
                                        </div>
                                    {% endif %}
                                    
                                    {% crispy form %}
                                </div>
                            {% endfor %}
                        </div>
                        
                        <button type="button" class="btn btn-outline-primary" id="add-photo">
                            <i class="bi bi-plus"></i> Ajouter une photo
                        </button>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i> Enregistrer
                    </button>
                    <a href="{% if artwork %}{{ artwork.get_absolute_url }}{% else %}{% url 'artworks:list' %}{% endif %}" 
                       class="btn btn-outline-secondary">
                        Annuler
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% load static %}{% static 'js/select_or_create.js' %}"></script>
<script>
// Gestion dynamique des formsets de photos
document.addEventListener('DOMContentLoaded', function() {
    const photoFormsContainer = document.getElementById('photo-forms');
    const addPhotoBtn = document.getElementById('add-photo');
    const managementForm = document.querySelector('[name="photos-TOTAL_FORMS"]');
    const maxForms = parseInt(document.querySelector('[name="photos-MAX_NUM_FORMS"]').value);
    
    // Fonction pour mettre à jour le nombre total de formulaires
    function updateTotalForms() {
        const totalForms = document.querySelectorAll('.photo-form:not(.deleted)').length;
        managementForm.value = totalForms;
    }
    
    // Fonction pour gérer la prévisualisation des images
    function setupImagePreview(form) {
        const fileInput = form.querySelector('input[type="file"]');
        const deleteCheckbox = form.querySelector('input[type="checkbox"][name$="-DELETE"]');
        
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        let preview = form.querySelector('.photo-preview');
                        if (!preview) {
                            preview = document.createElement('img');
                            preview.className = 'photo-preview mb-2';
                            form.insertBefore(preview, form.firstChild);
                        }
                        preview.src = e.target.result;
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }
        
        if (deleteCheckbox) {
            deleteCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    form.classList.add('deleted');
                } else {
                    form.classList.remove('deleted');
                }
                updateTotalForms();
            });
        }
    }
    
    // Initialiser les formulaires existants
    document.querySelectorAll('.photo-form').forEach(setupImagePreview);
    
    // Ajouter un nouveau formulaire
    if (addPhotoBtn) {
        addPhotoBtn.addEventListener('click', function() {
            const currentForms = document.querySelectorAll('.photo-form:not(.deleted)').length;
            
            if (currentForms >= maxForms) {
                alert('Nombre maximum de photos atteint');
                return;
            }
            
            // Cloner le premier formulaire
            const firstForm = document.querySelector('.photo-form');
            if (firstForm) {
                const newForm = firstForm.cloneNode(true);
                const newIndex = currentForms;
                
                // Mettre à jour les noms des champs
                newForm.querySelectorAll('input, select, textarea').forEach(function(input) {
                    if (input.name) {
                        input.name = input.name.replace(/photos-\d+/, 'photos-' + newIndex);
                        input.id = input.id.replace(/photos-\d+/, 'photos-' + newIndex);
                    }
                    if (input.name && input.name.includes('DELETE')) {
                        input.checked = false;
                    }
                    if (input.type === 'file') {
                        input.value = '';
                    } else if (input.type !== 'checkbox') {
                        input.value = '';
                    }
                });
                
                // Mettre à jour les labels
                newForm.querySelectorAll('label').forEach(function(label) {
                    if (label.getAttribute('for')) {
                        label.setAttribute('for', label.getAttribute('for').replace(/photos-\d+/, 'photos-' + newIndex));
                    }
                });
                
                // Supprimer la prévisualisation existante
                const existingPreview = newForm.querySelector('.photo-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                newForm.classList.remove('deleted');
                newForm.setAttribute('data-form-index', newIndex);
                
                photoFormsContainer.appendChild(newForm);
                setupImagePreview(newForm);
                updateTotalForms();
            }
        });
    }
    
    // Initialiser le compteur
    updateTotalForms();
});
</script>
<script>
// Tooltips Bootstrap
document.addEventListener('DOMContentLoaded', function() {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

// Repli des sections (fieldsets) pour aérer
document.addEventListener('DOMContentLoaded', function () {
  const collapseByDefault = new Set([
    'Acquisition et provenance',
    'Localisation et statut',
    'Informations complémentaires'
  ]);

  const fieldsets = document.querySelectorAll('form fieldset');
  let idx = 0;

  fieldsets.forEach(fs => {
    const legend = fs.querySelector('legend');
    if (!legend) return;

    const contentWrapper = document.createElement('div');
    const collapseId = `fs-collapse-${idx++}`;
    const shouldCollapse = collapseByDefault.has(legend.textContent.trim());

    // Déplacer tout le contenu (sauf la légende) dans la div collapsable
    const nodesToMove = [];
    Array.from(fs.childNodes).forEach(n => {
      if (n !== legend) nodesToMove.push(n);
    });
    contentWrapper.className = `collapse ${shouldCollapse ? '' : 'show'}`;
    contentWrapper.id = collapseId;
    nodesToMove.forEach(n => contentWrapper.appendChild(n));
    fs.appendChild(contentWrapper);

    // Bouton toggler à côté de la légende
    const toggleBtn = document.createElement('button');
    toggleBtn.type = 'button';
    toggleBtn.className = 'btn btn-link p-0 text-decoration-none';
    toggleBtn.setAttribute('data-bs-toggle', 'collapse');
    toggleBtn.setAttribute('data-bs-target', `#${collapseId}`);
    toggleBtn.setAttribute('aria-expanded', shouldCollapse ? 'false' : 'true');
    toggleBtn.innerHTML = shouldCollapse ? '<i class="bi bi-caret-right-fill"></i>' : '<i class="bi bi-caret-down-fill"></i>';

    // Mettre le libellé dans un conteneur cliquable
    const labelSpan = document.createElement('span');
    labelSpan.textContent = legend.textContent.trim();

    legend.textContent = '';
    legend.appendChild(toggleBtn);
    legend.appendChild(labelSpan);

    // Sync icône avec l’état du collapse
    contentWrapper.addEventListener('shown.bs.collapse', () => {
      toggleBtn.innerHTML = '<i class="bi bi-caret-down-fill"></i>';
      toggleBtn.setAttribute('aria-expanded', 'true');
    });
    contentWrapper.addEventListener('hidden.bs.collapse', () => {
      toggleBtn.innerHTML = '<i class="bi bi-caret-right-fill"></i>';
      toggleBtn.setAttribute('aria-expanded', 'false');
    });
  });
});
</script>
<script>
// Éditeur de tags (chips) pour Taggit: empêche Enter de soumettre, autocomplétion
document.addEventListener('DOMContentLoaded', function () {
  if (window.__auraTagsEditorInitialized) return;
  window.__auraTagsEditorInitialized = true;

  const inputs = document.querySelectorAll('input[name="tags"]');
  if (!inputs.length) return;
  // Taggit utilise un input texte; s'il y en a plusieurs, on les masque tous et on ne garde que le premier pour la valeur
  inputs.forEach(inp => { inp.style.display = 'none'; });
  const hiddenInput = inputs[0];
  // Au cas où il existerait un select résiduel
  document.querySelectorAll('select[name="tags"]').forEach(sel => sel.style.display = 'none');

  // Masquer l'input natif (CSV attendu par Taggit)
  hiddenInput.style.display = 'none';

  // État interne
  let tags = hiddenInput.value
    .split(',')
    .map(s => s.trim())
    .filter(Boolean);

  // UI editor
  const editor = document.createElement('div');
  editor.className = 'form-control d-flex flex-wrap gap-2 align-items-center';
  editor.style.minHeight = 'calc(2.5rem + 2px)';
  editor.style.cursor = 'text';
  editor.tabIndex = 0;

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'border-0 flex-grow-1';
  input.placeholder = 'Rechercher ou créer un mot-clé…';
  input.style.outline = 'none';
  input.style.minWidth = '10ch';
  editor.appendChild(input);

  hiddenInput.parentNode.insertBefore(editor, hiddenInput.nextSibling);

  const help = document.createElement('div');
  help.className = 'form-text mt-1';
  help.textContent = 'Tapez pour chercher, Entrée pour ajouter, ⌫ pour retirer le dernier';
  editor.parentNode.insertBefore(help, editor.nextSibling);

  // Dropdown
  const dropdown = document.createElement('div');
  dropdown.className = 'list-group position-absolute w-100 shadow';
  dropdown.style.zIndex = '1080';
  dropdown.style.display = 'none';
  const wrapper = document.createElement('div');
  wrapper.style.position = 'relative';
  editor.parentNode.insertBefore(wrapper, editor);
  wrapper.appendChild(editor);
  wrapper.appendChild(dropdown);

  function syncHidden() {
    hiddenInput.value = tags.join(', ');
  }
  function renderChips() {
    Array.from(editor.querySelectorAll('span.badge')).forEach(n => n.remove());
    tags.forEach(label => {
      const chip = document.createElement('span');
      chip.className = 'badge text-bg-primary d-inline-flex align-items-center';
      chip.style.padding = '0.5rem 0.6rem';
      chip.style.gap = '0.4rem';
      chip.appendChild(document.createTextNode(label));
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn-close btn-close-white btn-sm ms-1';
      btn.ariaLabel = 'Retirer';
      btn.addEventListener('click', () => {
        tags = tags.filter(t => t !== label);
        syncHidden();
        renderChips();
      });
      chip.appendChild(btn);
      editor.insertBefore(chip, input);
    });
  }
  function addTag(value) {
    const val = String(value).trim();
    if (!val) return;
    if (!tags.includes(val)) {
      tags.push(val);
      syncHidden();
      renderChips();
    }
  }
  renderChips();

  // Focus
  editor.addEventListener('click', () => input.focus());

  // Empêcher Enter de soumettre le formulaire
  const formEl = hiddenInput.closest('form');
  if (formEl) {
    formEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement === input) {
        e.preventDefault();
      }
    });
  }
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const q = input.value.trim();
      if (q) {
        addTag(q);
        input.value = '';
        hideDropdown();
      }
    } else if (e.key === 'Backspace' && input.value === '') {
      const last = tags[tags.length - 1];
      if (last) {
        tags.pop();
        syncHidden();
        renderChips();
      }
    }
  });

  // Autocomplete
  let suggestions = [];
  let lastQuery = '';
  function hideDropdown() { dropdown.style.display = 'none'; }
  function renderDropdown(query) {
    dropdown.innerHTML = '';
    const q = String(query || '').trim().toLowerCase();
    const items = suggestions
      .filter(s => !q || (s.text || '').toLowerCase().includes(q))
      .slice(0, 10);
    if (q && !items.some(i => (i.text || '').toLowerCase() === q)) {
      items.unshift({ value: q, text: `Ajouter "${q}"` });
    }
    if (!items.length) return hideDropdown();
    items.forEach(item => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'list-group-item list-group-item-action';
      b.textContent = item.text;
      b.addEventListener('click', () => {
        const v = item.value || item.text;
        addTag(v);
        input.value = '';
        hideDropdown();
        input.focus();
      });
      dropdown.appendChild(b);
    });
    dropdown.style.display = 'block';
  }
  function fetchSuggestions(query) {
    const url = new URL('{% url "artworks:tags_autocomplete" %}', window.location.origin);
    if (query) url.searchParams.set('q', query);
    return fetch(url.toString(), { credentials: 'same-origin' })
      .then(r => r.json())
      .then(json => { suggestions = json || []; })
      .catch(() => { suggestions = []; });
  }
  input.addEventListener('input', async () => {
    const q = input.value.trim();
    if (q === lastQuery) return renderDropdown(q);
    lastQuery = q;
    await fetchSuggestions(q);
    renderDropdown(q);
  });
  document.addEventListener('click', (e) => {
    if (!wrapper.contains(e.target)) hideDropdown();
  });
});
</script>
{% endblock %}
{% endblock %}