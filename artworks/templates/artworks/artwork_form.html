{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} - Catalogue{% endblock %}

{% block extra_css %}
<style>
    .photo-preview {
        max-width: 150px;
        max-height: 150px;
        object-fit: cover;
        border-radius: 0.375rem;
    }
    
    .select-or-create-wrapper,
    .select-multiple-or-create-wrapper {
        display: flex;
        gap: 10px;
        align-items: flex-start;
    }
    
    .select-or-create,
    .select-multiple-or-create {
        flex: 1;
    }
    
    .keyword-input-wrapper {
        position: relative;
    }
    
    .keyword-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">{{ title }}</h1>
                <a href="{% if artwork %}{{ artwork.get_absolute_url }}{% else %}{% url 'artworks:list' %}{% endif %}" 
                   class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Annuler
                </a>
            </div>
            
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% if form.errors %}
                  <div class="alert alert-danger">
                    {{ form.errors }}
                  </div>
                {% endif %}
             
                {% if photo_formset.non_form_errors %}
                  <div class="alert alert-danger">
                    {{ photo_formset.non_form_errors }}
                  </div>
                {% endif %}
             
                {% for f in photo_formset %}
                  {% if f.errors %}
                    <div class="alert alert-danger">
                      {{ f.errors }}
                    </div>
                  {% endif %}
                {% endfor %}
                  <div class="card">
                      <div class="card-body">
                        {% crispy form %}
                    </div>
                </div>
                
                <!-- Photos -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-images"></i> Photos
                        </h5>
                    </div>
                    <div class="card-body">
                        {{ photo_formset.management_form }}
                        {% for form in photo_formset %}
                            <div class="photo-form mb-3 p-3 border rounded">
                                {% if form.instance.image %}
                                    <div class="mb-2">
                                        <img src="{{ form.instance.image.url }}" class="photo-preview">
                                    </div>
                                {% endif %}
                                {% crispy form %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% load static %}{% static 'js/select_or_create.js' %}"></script>
<script>
// Gestion dynamique des formsets de photos
document.addEventListener('DOMContentLoaded', function() {
    const photoForms = document.querySelectorAll('.photo-form');
    
    photoForms.forEach(function(form) {
        const fileInput = form.querySelector('input[type="file"]');
        const deleteCheckbox = form.querySelector('input[type="checkbox"][name$="-DELETE"]');
        
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        let preview = form.querySelector('.photo-preview');
                        if (!preview) {
                            preview = document.createElement('img');
                            preview.className = 'photo-preview mb-2';
                            form.insertBefore(preview, form.firstChild);
                        }
                        preview.src = e.target.result;
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }
        
        if (deleteCheckbox) {
            deleteCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    form.style.opacity = '0.5';
                } else {
                    form.style.opacity = '1';
                }
            });
        }
    });
});
</script>
{% endblock %}
{% endblock %}